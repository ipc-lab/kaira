name: Generate Auto Examples

on:
  push:
    branches: [main, dev]
    paths:
      - "examples/**"
      - "docs/conf.py"
      - "scripts/download_auto_examples.py"
      - "scripts/build_incremental_examples.py"
      - "requirements*.txt"
      - ".github/workflows/generate-examples.yml"
  pull_request:
    branches: [main]
    paths:
      - "examples/**"
      - "docs/conf.py"
      - "scripts/download_auto_examples.py"
      - "scripts/build_incremental_examples.py"
      - "requirements*.txt"
      - ".github/workflows/generate-examples.yml"
  release:
    types: [published]

# Required permissions for the workflow
permissions:
  actions: read # Required for downloading workflow artifacts
  contents: read # Required for checking out repository and creating releases
  pull-requests: read # Required for PR operations
  id-token: write # Required for uploading artifacts

# Cancel previous runs if a new push happens
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job to detect changes and set up conditions
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      examples-changed: ${{ steps.changes.outputs.examples }}
      force-build: ${{ steps.check-force.outputs.force }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for proper change detection

      - name: Detect changes in example-related files
        id: changes
        run: |
          echo "Detecting changes in example-related files..."

          # Define paths to monitor
          PATHS=(
            "examples/"
            "docs/conf.py"
            "scripts/download_auto_examples.py"
            "scripts/build_incremental_examples.py"
            "requirements*.txt"
            ".github/workflows/generate-examples.yml"
          )

          # Initialize changed flag
          EXAMPLES_CHANGED="false"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, compare against the base branch
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            echo "Comparing PR: $BASE_SHA..$HEAD_SHA"

            # Check if any monitored paths have changes
            for path in "${PATHS[@]}"; do
              if git diff --name-only "$BASE_SHA..$HEAD_SHA" | grep -E "^${path//\*/.*}" > /dev/null; then
                echo "Changes detected in: $path"
                EXAMPLES_CHANGED="true"
                break
              fi
            done
          elif [ "${{ github.event_name }}" = "push" ]; then
            # For pushes, compare against previous commit
            if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              BEFORE_SHA="${{ github.event.before }}"
              AFTER_SHA="${{ github.sha }}"
              echo "Comparing push: $BEFORE_SHA..$AFTER_SHA"

              # Check if both commits exist before trying to diff
              if git cat-file -e "$BEFORE_SHA" 2>/dev/null && git cat-file -e "$AFTER_SHA" 2>/dev/null; then
                # Check if any monitored paths have changes
                for path in "${PATHS[@]}"; do
                  if git diff --name-only "$BEFORE_SHA..$AFTER_SHA" | grep -E "^${path//\*/.*}" > /dev/null; then
                    echo "Changes detected in: $path"
                    EXAMPLES_CHANGED="true"
                    break
                  fi
                done
              else
                echo "‚ö†Ô∏è Previous commit $BEFORE_SHA not accessible (likely force push or shallow clone)"
                echo "Treating as changed to ensure examples are updated"
                EXAMPLES_CHANGED="true"
              fi
            else
              # First commit or force push, consider as changed
              echo "First commit or force push detected"
              EXAMPLES_CHANGED="true"
            fi
          else
            # For other events (like release), don't auto-detect changes
            echo "Event type: ${{ github.event_name }} - no automatic change detection"
            EXAMPLES_CHANGED="false"
          fi

          echo "examples=$EXAMPLES_CHANGED" >> $GITHUB_OUTPUT
          echo "Examples changed: $EXAMPLES_CHANGED"

      - name: Check for force build conditions
        id: check-force
        run: |
          # Always build on releases
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "force=true" >> $GITHUB_OUTPUT
            echo "Force build: Release event"
          # Always build on main branch pushes (for consistency)
          elif [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "force=true" >> $GITHUB_OUTPUT
            echo "Force build: Push to main branch"
          # Check for [rebuild-examples] in commit message
          elif echo "${{ github.event.head_commit.message }}" | grep -q "\[rebuild-examples\]"; then
            echo "force=true" >> $GITHUB_OUTPUT
            echo "Force build: Rebuild examples requested in commit message"
          else
            echo "force=false" >> $GITHUB_OUTPUT
            echo "No force build conditions met"
          fi

  generate-examples:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.examples-changed == 'true' || needs.detect-changes.outputs.force-build == 'true'
    strategy:
      matrix:
        python-version: ["3.13.2"]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history to ensure we have all commits for comparison

      - name: Log build reason
        run: |
          echo "=== Auto-Examples Build Information ==="
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Current commit: ${{ github.sha }}"
          if [ "${{ needs.detect-changes.outputs.examples-changed }}" = "true" ]; then
            echo "Reason: Example-related files changed"
          fi
          if [ "${{ needs.detect-changes.outputs.force-build }}" = "true" ]; then
            echo "Reason: Force build condition met"
          fi
          echo "======================================"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      - name: Install GitHub CLI
        run: |
          # Install GitHub CLI for workflow API access
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install -e .

      - name: Download latest auto_examples from releases
        run: |
          echo "üîΩ Downloading latest auto_examples from GitHub releases..."
          python scripts/download_auto_examples.py
          if [ -d "docs/auto_examples" ]; then
            echo "‚úÖ Downloaded existing auto_examples from releases"
            echo "Files: $(find docs/auto_examples -name "*.py" | wc -l) Python files"
            echo "Images: $(find docs/auto_examples -name "*.png" -o -name "*.jpg" -o -name "*.svg" | wc -l) image files"
            echo "Size: $(du -sh docs/auto_examples | cut -f1)"
          else
            echo "‚ÑπÔ∏è No existing auto_examples found in releases, will build from scratch"
          fi

      - name: Get last successful workflow commit
        id: last-success
        run: |
          echo "üîç Finding last successful workflow run..."

          # Get the last successful workflow run for this branch/workflow
          LAST_SUCCESS_SHA=""

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, use the base branch as reference
            LAST_SUCCESS_SHA="${{ github.event.pull_request.base.sha }}"
            echo "Using PR base as reference: $LAST_SUCCESS_SHA"
          else
            # For pushes, find the last successful run on this branch
            echo "Searching for last successful workflow run..."

            # Use GitHub CLI to get last successful run
            LAST_SUCCESS_SHA=$(gh run list \
              --workflow="generate-examples.yml" \
              --branch="${{ github.ref_name }}" \
              --status=completed \
              --conclusion=success \
              --limit=10 \
              --json headSha \
              --jq '.[0].headSha' 2>/dev/null || echo "")

            if [ -n "$LAST_SUCCESS_SHA" ] && [ "$LAST_SUCCESS_SHA" != "null" ]; then
              echo "Found last successful run at commit: $LAST_SUCCESS_SHA"
            else
              echo "‚ö†Ô∏è No previous successful run found, will compare against previous commit"
              # Fallback to previous commit comparison
              if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
                LAST_SUCCESS_SHA="${{ github.event.before }}"
              else
                echo "‚ö†Ô∏è No previous commit available, treating all examples as changed"
                LAST_SUCCESS_SHA=""
              fi
            fi
          fi

          echo "last_success_sha=$LAST_SUCCESS_SHA" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Detect changed example files
        id: changed-examples
        run: |
          echo "üîç Detecting changed example files..."

          LAST_SUCCESS_SHA="${{ steps.last-success.outputs.last_success_sha }}"
          CURRENT_SHA="${{ github.sha }}"

          if [ -n "$LAST_SUCCESS_SHA" ] && [ "$LAST_SUCCESS_SHA" != "$CURRENT_SHA" ]; then
            echo "Comparing against last successful workflow: $LAST_SUCCESS_SHA..$CURRENT_SHA"

            # Check if the reference commit exists
            if git cat-file -e "$LAST_SUCCESS_SHA" 2>/dev/null; then
              changed_files=$(git diff --name-only "$LAST_SUCCESS_SHA..$CURRENT_SHA" | grep '^examples/.*\.py$' || true)
              echo "Successfully compared against last successful run"
            else
              echo "‚ö†Ô∏è Last successful commit $LAST_SUCCESS_SHA not accessible in current checkout"
              echo "This might happen with shallow clones - treating all examples as changed"
              changed_files=$(find examples -name "*.py" -type f)
            fi
          else
            if [ "$LAST_SUCCESS_SHA" = "$CURRENT_SHA" ]; then
              echo "‚ÑπÔ∏è Current commit is the same as last successful run - no changes"
              changed_files=""
            else
              echo "‚ö†Ô∏è No reference commit available - treating all examples as changed"
              changed_files=$(find examples -name "*.py" -type f)
            fi
          fi

          if [ -z "$changed_files" ]; then
            echo "No example files changed since last successful build"
            echo "changed_count=0" >> $GITHUB_OUTPUT
            echo "changed_files=" >> $GITHUB_OUTPUT
          else
            echo "Changed example files since last successful build:"
            echo "$changed_files"
            echo "changed_count=$(echo "$changed_files" | wc -l)" >> $GITHUB_OUTPUT
            # Store changed files (newlines replaced with spaces for GitHub Actions)
            echo "changed_files=$(echo "$changed_files" | tr '\n' ' ')" >> $GITHUB_OUTPUT
          fi

      - name: Remove generated files for changed examples
        if: steps.changed-examples.outputs.changed_count > 0
        run: |
          echo "üóëÔ∏è Removing generated files for changed examples..."
          changed_files="${{ steps.changed-examples.outputs.changed_files }}"

          for example_file in $changed_files; do
            if [ -f "$example_file" ]; then
              # Convert examples/category/plot_example.py to auto_examples/category/plot_example.py
              auto_example_file=$(echo "$example_file" | sed 's|^examples/|docs/auto_examples/|')
              auto_example_dir=$(dirname "$auto_example_file")
              auto_example_base=$(basename "$auto_example_file" .py)

              echo "  Processing: $example_file"
              echo "    -> Auto example: $auto_example_file"

              if [ -d "$auto_example_dir" ]; then
                # Remove the main Python file
                if [ -f "$auto_example_file" ]; then
                  rm -f "$auto_example_file"
                  echo "    ‚úÖ Removed: $auto_example_file"
                fi

                # Remove associated files (images, notebooks, etc.)
                rm -f "${auto_example_dir}/${auto_example_base}"*.png
                rm -f "${auto_example_dir}/${auto_example_base}"*.jpg
                rm -f "${auto_example_dir}/${auto_example_base}"*.svg
                rm -f "${auto_example_dir}/${auto_example_base}"*.ipynb
                rm -f "${auto_example_dir}/${auto_example_base}"*.zip

                echo "    ‚úÖ Removed associated files for: $auto_example_base"
              else
                echo "    ‚ÑπÔ∏è Auto examples directory doesn't exist yet: $auto_example_dir"
              fi
            fi
          done

          echo "üéØ Removed generated files for ${{ steps.changed-examples.outputs.changed_count }} changed examples"

      - name: Generate auto_examples (incremental)
        run: |
          cd docs
          changed_count="${{ steps.changed-examples.outputs.changed_count }}"
          total_examples=$(find ../examples -name "*.py" | wc -l)

          if [ "$changed_count" -gt 0 ] && [ -d "auto_examples" ]; then
            echo "üîÑ Generating auto_examples (incremental build)"
            echo "Changed files: $changed_count out of $total_examples total"

            # Use the incremental build script
            changed_files="${{ steps.changed-examples.outputs.changed_files }}"
            echo "Running incremental build for: $changed_files"

            python ../scripts/build_incremental_examples.py \
              --changed-files "$changed_files" \
              --docs-dir . \
              --fallback-full-build

          else
            echo "üîÑ Generating auto_examples (full build)"
            if [ "$changed_count" -eq 0 ]; then
              echo "Reason: No changed files detected"
            else
              echo "Reason: No existing auto_examples base found"
            fi

            # Use sphinx-build to generate the complete gallery
            sphinx-build -b html \
              -D sphinx_gallery_conf.plot_gallery=True \
              -D sphinx_gallery_conf.download_all_examples=True \
              . _build/html -v
          fi

      - name: Verify auto_examples generation
        run: |
          if [ -d "docs/auto_examples" ]; then
            echo "‚úÖ auto_examples directory exists"

            # Show first few generated files
            echo "üìÑ Sample generated files:"
            find docs/auto_examples -type f -name "*.py" | head -10

            # Statistics
            python_files=$(find docs/auto_examples -name "*.py" | wc -l)
            image_files=$(find docs/auto_examples -name "*.png" -o -name "*.jpg" -o -name "*.svg" | wc -l)
            notebook_files=$(find docs/auto_examples -name "*.ipynb" | wc -l)
            total_size=$(du -sh docs/auto_examples | cut -f1)

            echo "üìä Generation Statistics:"
            echo "  - Python files: $python_files"
            echo "  - Image files: $image_files"
            echo "  - Notebook files: $notebook_files"
            echo "  - Total size: $total_size"

            # Show what was actually built vs reused
            changed_count="${{ steps.changed-examples.outputs.changed_count }}"
            total_examples=$(find examples -name "*.py" | wc -l)

            if [ "$changed_count" -gt 0 ] && [ "$changed_count" -lt "$total_examples" ]; then
              reused_count=$((total_examples - changed_count))
              echo "üéØ Incremental Build Summary:"
              echo "  - Rebuilt: $changed_count examples"
              echo "  - Reused: $reused_count examples"
              # Calculate percentage without bc dependency
              efficiency_percent=$((reused_count * 100 / total_examples))
              echo "  - Efficiency: ${efficiency_percent}% reused"
            else
              echo "üîÑ Full Build: Generated all examples"
            fi
          else
            echo "‚ùå ERROR: auto_examples directory was not created"
            exit 1
          fi

      - name: Create auto_examples archive
        run: |
          cd docs
          # Create a zip archive of the auto_examples directory
          zip -r auto_examples.zip auto_examples/
          archive_size=$(ls -lh auto_examples.zip | awk '{print $5}')

          # Add build metadata to the archive
          changed_count="${{ steps.changed-examples.outputs.changed_count }}"
          total_examples=$(find ../examples -name "*.py" | wc -l)

          echo "üì¶ Archive Information:"
          echo "  - File: auto_examples.zip"
          echo "  - Size: $archive_size"
          echo "  - Total examples: $total_examples"

          if [ "$changed_count" -gt 0 ] && [ "$changed_count" -lt "$total_examples" ]; then
            reused_count=$((total_examples - changed_count))
            echo "  - Build type: Incremental ($changed_count rebuilt, $reused_count reused)"
          else
            echo "  - Build type: Full build"
          fi

          echo "  - Commit: ${{ github.sha }}"
          echo "  - Event: ${{ github.event_name }}"

      - name: Upload auto_examples as artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: auto_examples-${{ github.sha }}-incremental
          path: docs/auto_examples.zip
          retention-days: 30

      - name: Create/Update auto-examples release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "üöÄ Creating/updating auto-examples release..."

          # Check if auto-examples release exists
          RELEASE_TAG="auto-examples-latest"
          RELEASE_NAME="Auto-generated Examples (Latest)"

          # Try to get existing release
          if gh release view "$RELEASE_TAG" > /dev/null 2>&1; then
            echo "Updating existing release: $RELEASE_TAG"

            # Delete existing asset if it exists
            if gh release view "$RELEASE_TAG" --json assets --jq '.assets[].name' | grep -q "auto_examples.zip"; then
              echo "Deleting existing auto_examples.zip asset..."
              gh release delete-asset "$RELEASE_TAG" auto_examples.zip --yes
            fi

            # Upload new asset
            gh release upload "$RELEASE_TAG" docs/auto_examples.zip --clobber
          else
            echo "Creating new release: $RELEASE_TAG"
            gh release create "$RELEASE_TAG" docs/auto_examples.zip \
              --title "$RELEASE_NAME" \
              --notes "This release contains the latest auto-generated examples for incremental builds. Updated automatically by GitHub Actions." \
              --target main
          fi

          echo "‚úÖ Successfully updated auto-examples release"
        env:
          GH_TOKEN: ${{ github.token }}

  # Job to report when examples are skipped
  skip-examples:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.examples-changed == 'false' && needs.detect-changes.outputs.force-build == 'false'
    steps:
      - name: Report skip reason
        run: |
          echo "‚è≠Ô∏è Skipping auto-examples generation"
          echo "Reason: No changes detected in example-related files"
          echo ""
          echo "üîç Files monitored for changes:"
          echo "  - examples/**"
          echo "  - docs/conf.py"
          echo "  - scripts/download_auto_examples.py"
          echo "  - scripts/build_incremental_examples.py"
          echo "  - requirements*.txt"
          echo "  - .github/workflows/generate-examples.yml"
          echo ""
          echo "üí° When changes are detected, the workflow will:"
          echo "  1. Download latest auto_examples as base"
          echo "  2. Remove generated files for changed examples only"
          echo "  3. Rebuild only the changed examples (incremental build)"
          echo "  4. Upload the updated auto_examples archive"
          echo ""
          echo "üöÄ To force rebuild, include '[rebuild-examples]' in commit message"
